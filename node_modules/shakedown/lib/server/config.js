import log from 'sd/log';
import mixin from 'sd/mixin';
import Parallel from 'sd/Parallel';
import text from 'sd/text';
import {decode} from 'sd/yamlish';

export default function load(paths, callback){

    var parallel = new Parallel;
    text('sd/server/config.yaml', parallel.add());
    paths.forEach(function(path){
        text(path + '/config.yaml', parallel.add());
    })

    parallel.then(function(){
        var err = arguments[0];
        if (err) {log(err); callback(err); return;}

        var config = decode(arguments[1]);
        var partialConfig;
        
        for (var i = 2; i < arguments.length; i++){
            partialConfig = decode(arguments[i]);
            if (partialConfig.bundles)
                for (var j in partialConfig.bundles)
                    partialConfig.bundles[j].path = paths[i - 2]
            config = mixin(config, partialConfig);
        }

        callback(null, config);
    });
}
