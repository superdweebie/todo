import http from 'http'
import fs from 'fs'
import url from 'url'


    respond = function(request, response, content, contentType){
        response.setHeader("Content-Type", contentType);
        response.write(content);
        response.end();
        console.log(request.method + ' ' + request.url + ' ' + response.statusCode);
    },

    respond404 = function(request, response){
        response.writeHeader(404, {"Content-Type": 'text/html'});
        response.write('404. Resource not found.');
        response.end();
        console.log('404 sent for ' + request.url);
    },

    returnPackageFile = function(request, response){
        var pathPieces = url.parse(request.url).pathname.split('/');

        pathPieces.shift();
        var packageName = pathPieces.shift();

        fs.readFile(packages[packageName] + '/' + pathPieces.join('/'), function (err, content) {
            if (err) {
                throw err;
            }
            respond(request, response, content, 'text/javascript');
        })
    },

    returnRenderedPage = function(request, response){
        Twig.renderFile(twigDir + getFilePath(request, 'twig'), getParams(request), function (err, content) {
            if (err) {
                respond404(request, response);
                return;
            }
            respond(request, response, content, 'text/html');
        })
    },

    returnResource = function(request, response){
        var contentType;
        switch (request.url.split('.').pop()){
            case 'png':
                contentType = 'image/png';
                break;
            case 'js':
                contentType = 'text/javascript';
                break;
            case 'css':
                contentType = 'text/css';
                break;
        }
        fs.readFile(twigDir + request.url, function (err, content) {
            if (err) {
                respond404(request, response);
                return;
            }
            respond(request, response, content, contentType);
        })
    };

var loadConfig = function(path){

}

var start = function(path, callback){

}

http.createServer(function(request, response) {

    var pathPieces = url.parse(request.url).pathname.split('/');

    if (pathPieces[1] == ''){
        request.url = '/index.html';
        returnRenderedPage(request, response);
    } else if (pathPieces[1] in packages){
        //A file from one of the js packages has been requested.
        //Just return that file.
        returnPackageFile(request, response);
    } else if (pathPieces[1] == 'api') {
        //api request
        require('./' + camelCase(pathPieces[2])).handle(request, response, function(err, content){
            if (err) {
                console.log(err);
                respond404(request, response);
                return;
            }
            respond(request, response, content, 'application/json');
        });
    } else if (request.url.split('.').pop() == 'html') {
        returnRenderedPage(request, response);
    } else {
        returnResource(request, response);
    }
}).listen(80, '127.0.0.1');

console.log("Shakedown running at http://127.0.0.1:80/");

export start;